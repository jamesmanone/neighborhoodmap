const locations=[{id:1,title:"Jannus Live",location:{lat:27.771671,lng:-82.636063}},{id:2,title:"Demens Landing",location:{lat:27.771407,lng:-82.627915}},{id:3,title:"The Dali Museum",location:{lat:27.765923,lng:-82.63139}},{id:4,title:"Mahaffey Theater",location:{lat:27.767222,lng:-82.631944}},{id:5,title:"Vinoy Park",location:{lat:27.7786,lng:-82.6257}},{id:6,title:"Al Lang Stadium",location:{lat:27.7681,lng:-82.6331}},{id:7,title:"State Theatre St. Petersburg",location:{lat:27.77142,lng:-82.64337}},{id:8,title:"Albert Whitted Airport",location:{lat:27.765,lng:-82.626944}},{id:9,title:"The Birchwood",location:{lat:27.77602,lng:-82.632052}},{id:10,title:"Tropicana Field",location:{lat:27.768333,lng:-82.653333}}];class Location{constructor(e){this.title=ko.observable(e.title),this.location=ko.observable(e.location),this.id=ko.observable(e.id),this.visible=ko.observable(!0),this.wikiText=ko.observable(),this.flickrUrls=ko.observableArray(),this.yelpData=ko.observable(),this.yelpRating=ko.observable(),this.yelpReviews=ko.observableArray()}getFlickr(e){return new Promise((t,i)=>{var n=setTimeout(()=>i("Request Timed out"),1e4);fetch(`https://api.flickr.com/services/rest/?method=flickr.photos.search&format=json&nojsoncallback=1&api_key=0e1c35e1a3ae55371b56a4f54befe18e&radius=1&content_type=1&per_page=10&page=${e}&text=${this.title().replace(/\s+/g,"+")}&lat=${this.location().lat}&lon=${this.location().lng}`).then(e=>e.json()).catch(()=>i("There was a problem contancting Flickr")).then(e=>{t(e);clearTimeout(n)})})}getFlickrUrls(e){return new Promise((t,i)=>{setTimeout(()=>i("The request timed out"),1e4);let n=e.photos.photo;n.forEach(e=>this.getFlickrUrl(e))}).then(()=>{Promise.race(promises).then(()=>{clearTimeout(clock);resolve()}).catch(e=>{clearTimeout(clock);reject("Unable to fetch photos")})})}getFlickrUrl(e){return new Promise((t,i)=>{fetch(`https://api.flickr.com/services/rest/?method=flickr.photos.getSizes&format=json&nojsoncallback=1&api_key=0e1c35e1a3ae55371b56a4f54befe18e&photo_id=${e.id}`).then(e=>e.json()).catch(()=>i()).then(e=>{let n=e.sizes.size;if(n){for(const e of n)if("640"===e.width){this.flickrUrls.push(e.source),t(!0),viewModel.flickr()&&(viewModel.flickrMessage()||viewModel.modalStatus())&&(viewModel.flickrMessage(""),viewModel.modalStatus(""));break}}else i("No photos returned")})})}getWiki(){return new Promise((e,t)=>{const i=setTimeout(()=>t("The request timed out"),7e3);const n=`/wiki?page=${this.title()}`;fetch(n).catch(e=>t("Could not contact Wikipedia")).then(e=>e.json()).then(n=>{let o=n.parse.text["*"];o?(o=(o=(o=(o=(o=(o=o.replace(/<a[^>]+>([^<]+)<\/a>/g,"$1")).replace(/<a href="#cite[^>]+>/g,"")).replace(/<a href="#[^>]+>/g,"")).replace(/<span[^>]+>/g,"")).replace(/<\/span>/g,"")).replace(/\[edit[^\]]*\]/g,""),this.wikiText(o),clearTimeout(i),e()):t("<h2>Panic! The impossible happened.<br> <small>No articles? I must have weird taste</small></h2>")}).catch(e=>{console.log(e);t("<h2>Panic! The impossible happened.<br> <small>No articles? I must have weird taste</small></h2>")})})}getYelp(){return new Promise((e,t)=>{const i=setTimeout(()=>t("The request timed out"),1e4);fetch(`/yelp?query=${this.title()}&lat=${this.location().lat}&lng=${this.location().lng}`).then(e=>e.json()).catch(()=>t("There was a problem comunicating with yelp")).then(e=>{this.yelpRating(this.starsSrc(e.rating));return e}).then(e=>{this.yelpData(e);return e}).then(e=>fetch(`/yelpreviews/${e.id}`)).then(e=>e.json()).catch(()=>t("There was a problem getting reviews")).then(e=>{e.reviews.forEach(e=>e.ratingImg=this.starsSrc(e.rating));return e}).then(e=>e.reviews.forEach(e=>this.yelpReviews.push(e))).then(()=>{clearTimeout(i);e()})})}starsSrc(e){let t="/stars/";switch(e){case 0:t+="yelp0.png";break;case.5:t+="yelp05.png";break;case 1:t+="yelp1.png";break;case 1.5:t+="yelp15.png";break;case 2:t+="yelp2.png";break;case 2.5:t+="yelp25.png";break;case 3:t+="yelp3.png";break;case 3.5:t+="yelp35.png";break;case 4:t+="yelp4.png";break;case 4.5:t+="yelp45.png";break;case 5:t+="yelp5.png"}return t}}
function ListViewModel(){this.filterText=ko.observable(),this.locationList=ko.observableArray(),locations.forEach(i=>{this.locationList.push(new Location(i))}),this.selectedLocation=ko.observable(),this.loading=!1,this.flickr=ko.observable(!1),this.wiki=ko.observable(!1),this.yelp=ko.observable(!1),this.modalTitle=ko.observable(),this.modalStatus=ko.observable(),this.flickrMessage=ko.observable(),this.modalOpen=ko.computed(()=>this.flickr()||this.wiki()||this.yelp()),this.listOpen=ko.observable(!1),this.mapOpen=ko.computed(()=>{let i=window.innerWidth;return i>750||!this.listOpen()}),this.listClick=(i=>{this.selectedLocation()!=i?(this.selectedLocation(i),googleMap&&googleMap.markers&&googleMap.setMarkerFromList(i)):(this.selectedLocation(null),googleMap&&googleMap.markers&&googleMap.setMarkerFromList(null))}),this.listOpen.subscribe(()=>{window.innerWidth>750&&googleMap&&googleMap.resize()}),this.openFlickr=(()=>{this.wiki(!1);this.yelp(!1);this.flickr(!0);this.modalTitle("Flickr Images");this.modalStatus("");this.selectedLocation().flickrUrls().length||(this.modalStatus("Loading..."),this.moarFlickr())}),this.openWiki=(()=>{this.flickr(!1);this.yelp(!1);this.wiki(!0);this.modalTitle("Wikipedia");this.modalStatus("");this.selectedLocation().wikiText()||(this.modalStatus("Loading..."),this.selectedLocation().getWiki().then(()=>this.modalStatus("")).catch(i=>this.modalStatus(i)))}),this.openYelp=(()=>{this.flickr(!1);this.wiki(!1);this.yelp(!0);this.modalTitle("");this.modalStatus("");this.selectedLocation().yelpData()||(this.modalStatus("Loading..."),this.selectedLocation().getYelp().then(()=>this.modalStatus("")).catch(i=>this.modalStatus(i)))}),this.closeModal=(()=>{this.flickr(!1);this.wiki(!1);this.yelp(!1)}),this.filterText.subscribe(i=>this.filter(i)),this.filter=(i=>{i=i.toLowerCase();i?(googleMap&&googleMap.markers&&googleMap.markers.forEach(t=>{-1===t.title.toLowerCase().indexOf(i)?t.setVisible(!1):t.setVisible(!0)}),this.locationList().forEach(t=>{-1===t.title().toLowerCase().indexOf(i)?t.visible(!1):t.visible(!0)})):(googleMap&&googleMap.markers&&googleMap.markers.forEach(i=>i.setVisible(!0)),this.locationList().forEach(i=>i.visible(!0)));return!0}),this.moarFlickr=(()=>{if(!this.loading){this.loading=!0;let i=Math.round(this.selectedLocation().flickrUrls().length/10)+1,t=this.selectedLocation().flickrUrls().length;t?this.flickrMessage("Loading more photos"):this.modalStatus("Loading..."),this.selectedLocation().getFlickr(i).then(i=>this.selectedLocation().getFlickrUrls(i)).then(()=>{this.flickrMessage("");this.modalStatus("")}).catch(i=>{console.error(i);this.flickrMessage(`Error: ${i}`)}).then(()=>{this.loading=!1})}}),this.endlessFlickr=((i,t)=>{let o=t.target;this.flickr()?o.scrollTop>=o.scrollHeight-o.offsetHeight-400&&this.moarFlickr():this.loading}),this.openYelpReview=(i=>{window.open(i.url,"_blank")}),this.toggleList=(()=>{this.listOpen(!this.listOpen())})}
class GoogleMap{constructor(){this.map=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(27.772141,-82.637844),zoom:1}),this.infowindow=new google.maps.InfoWindow,this.bounds=new google.maps.LatLngBounds,this.markers=[],this.resizeTimeout=!1;for(let i=0;i<locations.length;i++){let t=locations[i].location,n=locations[i].title,o=locations[i].id,e=new google.maps.Marker({title:n,position:t,map:this.map,animation:google.maps.Animation.DROP,id:o});this.markers.push(e),this.ears(e),this.bounds.extend(t)}this.map.fitBounds(this.bounds),window.addEventListener("resize",this.resize.bind(this))}openInfoWindow(i){if(this.infowindow.marker!=i&&(this.infowindow.marker=i,this.markers.forEach(i=>i.setAnimation(null)),null!==this.infowindow.marker)){i.setAnimation(google.maps.Animation.BOUNCE);var t=setTimeout(()=>i.setAnimation(null),2800);this.infowindow.setContent(i.title),this.infowindow.addListener("closeclick",()=>{this.markers.forEach(i=>i.setAnimation(null));this.infowindow.marker=null;clearTimeout(t);viewModel.selectedLocation(null)}),this.infowindow.open(map,i)}}resize(){this.resizeTimeout||(console.log(this.resizeTimeout),this.resizeTimeout=!0,setTimeout(()=>this.resizeTimeout=!1,66),this.map.zoom=1,this.map.fitBounds(this.bounds))}ears(i){i.addListener("click",()=>{this.syncList(i);this.openInfoWindow(i)})}syncList(i){viewModel.locationList().forEach(t=>{if(t.title()===i.title)return void viewModel.selectedLocation(t)})}setMarkerFromList(i){if(i&&!this.infowindow.marker)this.markers.forEach(t=>{t.title===i.title()&&this.openInfoWindow(t)});else if(!i&&this.infowindow.marker)this.markers.forEach(i=>i.setAnimation(null)),this.infowindow.marker=null,this.infowindow.close();else{if(!i&&!this.infowindow.marker.title)return;i.title()!==this.infowindow.marker.title&&this.markers.forEach(t=>{t.title===i.title()&&this.openInfoWindow(t)})}}}
function mapsLoaded(){$(init)}function init(){window.innerWidth>750&&viewModel.listOpen(!0),ko.applyBindings(viewModel),googleMap=new GoogleMap}function ifNoGoogle(){$(noGoogle)}function noGoogle(){window.innerWidth>750&&viewModel.listOpen(!0),ko.applyBindings(viewModel);const o=document.getElementById("map");o.style.padding="10px",o.style["background-color"]="#999",o.innerHTML=`\n    <h1>Google Maps failed to load</h1>\n    <p>\n      This webapp is all about the map. If google is broken, so am I.\n    </p>\n    <p>\n      Feel free to check out Flickr images, Yelp reviews, and Wikipedia\n      articles on the right if the rest of the internet is somehow working, else\n      try refreshing the page.\n    </p>\n  `}const viewModel=new ListViewModel;let googleMap;